<% content_for :class_for_main, "container--wide" %>

<div class="stores-maps container js-stores-maps-toggle-wrap">

  <%# Contain 'back to listing link' and 'store details' %>
  <div class="stores-maps__inner stores-maps__inner--detail <%= 'is-featured-items' if !@products.empty? %>" id="stores-maps-toggle-listing-detail">

    <%# Back to listing link %>
    <div class="stores-maps__filters-toggle">
      <div class="container">

        <%# Small screen view %>
        <a href="<%= centre_stores_path(@centre) %>" class="stores-maps__toggle stores-maps__toggle--link btn btn--main btn--main-white btn--main-compact-icon js-maintain-store-filter">
          <span class="hide-visually">View stores</span>
          <span class="icon icon--list icon--lrg" aria-hidden="true"></span>
        </a>
        <%# //Small screen view %>

        <%# Large screen view %>
        <a href="<%= centre_stores_path(@centre) %>" class="stores-maps__filters-toggle__hdr txt-truncate js-maintain-store-filter">
          <span>
            <span class="icon icon--arrow-left-big" aria-hidden="true"></span>
            <span class="hide-visually">Back to </span>
            Stores
          </span>
          / <%= @store.name %>
        </a>
        <%# //Large screen view %>
      </div>
    </div>
    <%# //Back to listing link %>

    <%# Store details %>
    <div class="stores-maps__list-detail">

      <article class="storefront" role="article" itemscope itemtype="http://schema.org/Organization">

        <%# Header (carousel) %>
        <%= render @store.has_storefront? ? 'header_with_banner' : 'header_without_banner' %>
        <%# //Header (carousel) %>

        <%# Store details %>
        <div class="storefront__details">

          <%# Inner container %>
          <div class="container container--position">

            <%# Store meta %>
            <dl class="storefront__details__meta">

              <%# Store level %>
              <%- if @store.level.present? %>
                <dt class="hide-visually">Shopping centre level</dt>
                <dd class="hide-visually"><%= @store.level %></dd>
              <%- end %>
              <%# //Store level %>

              <%# Store closing time %>
              <%- if @store.closing_time.present? and !@store.closed_today? %>
                <dt class="hide-visually">Opening hours</dt>
                <dd class="storefront__details__meta__no-indent">Open till <time datetime="<%= @store.closing_time %>"><%= twelve_hour_format @store.closing_time %></time> tonight</dd>
              <%- else %>
                <dd class="storefront__details__meta__no-indent">Closed today</dd>
              <%- end %>
              <%# //Store closing time %>

              <%# Store phone no %>
              <%- if @store.phone_number.present? %>
                <dt class="hide-visually hide-fully--palm">Store phone number</dt>
                <dd class="hide-fully--palm" itemprop="telephone">
                  <%= phone_format @store.phone_number %>
                  <span class="icon icon--phone2 icon--xlrg icon--fixed-width" aria-hidden="true"></span>
                </dd>
              <%- end %>
              <%# //Store phone no %>

              <%# Store email %>
              <%- if @store.email_address.present? %>
                <dt class="hide-visually">Store email</dt>
                <dd class="txt-truncate">
                  <%= mail_to @store.email_address, @store.email_address, itemprop: 'email' %>
                  <span class="icon icon--email icon--xlrg icon--fixed-width" aria-hidden="true"></span>
                </dd>
              <%- end %>
              <%# //Store email %>

              <%# Store gift cards accepted %>
              <%- if @store.accepts_giftcards.present? %>
                <dt class="hide-visually">Westfield gift card</dt>
                <dd>
                  Gift card accepted in store
                  <span class="icon icon--gift-card icon--xlrg icon--fixed-width" aria-hidden="true"></span>
                </dd>
              <%- end %>
              <%# //Store gift cards accepted %>

            </dl>
            <%# //Store meta %>

            <%# Icon links - store phone no and location %>
            <div class="storefront__details__phone-map storefront-storelist-phone-map-links">

              <%# Phone no %>
              <%- if @store.phone_number.present? %>
                <%= phone_link @store.phone_number, class: 'storefront-storelist-phone-map-links__cell storefront-storelist-phone-map-links__cell--phone hide-fully--non-palm' do |phone_number| %>
                  <span class="hide-visually">
                    Call store:
                    <span itemprop="telephone"><%= phone_number %></span>
                  </span>
                  <span class="icon icon--phone2 icon--flush-top storefront-storelist-phone-map-links__cell__valign"></span>
                <% end %>
              <%- end %>
              <%# //Phone no %>

              <%# Location %>
              <a href="#infoDiv" class="storefront-storelist-phone-map-links__cell storefront-storelist-phone-map-links__cell--location" data-store-id="<%= @store.id %>">
                <span class="storefront-storelist-phone-map-links__cell__valign">
                  <span class="icon icon--pin icon--flush-top"></span>
                  <span class="hide-visually">Store location</span>
                </span>
              </a>
              <%# //Location %>

            </div>
            <%# //Icon links - store phone no and location %>

          </div>
          <%# //Inner container %>

        </div>
        <%# //Store details %>

        <%# 'Product' and 'Deal' tiles %>
        <%- if !@products.empty? %>
          <footer class="storefront__featured">

              <%# 'Product' tiles %>
              <div class="storefront__featured__item storefront__featured__item--products island-ends">
                <div class="container">
                  <h2 class="storefront__featured__hdr">Featured from <%= @store.name %></h2>
                  <ul class="grid grid--gutter-half grid--mrg-half">
                    <% @products.each do |product| %>
                      <li class="grid__item one-half non-palm-one-third">
                        <%= render partial: '/shared/tiles/product',
                            layout: '/layouts/tile',
                            locals: {
                              result: product,
                              options: {
                                height: 288
                              }
                            }
                          %>
                      </li>
                    <% end %>
                  </ul>
                  <%= link_to centre_products_path(retailer: [params[:retailer_code]]), class: 'storefront__featured__view-more' do %>
                    View more<span class="icon icon--arrow-right icon--lrg" aria-hidden="true"></span>
                  <% end %>
                </div>
              </div>
              <%# //Product tiles %>

              <%# Deal tiles %>
              <%- if false %>
              <div class="storefront__featured__item storefront__featured__item--deals island-ends">
                <div class="container">
                  <h2 class="storefront__featured__hdr">Deals from <%= @store.name %></h2>
                  <ul class="grid grid--gutter-half grid--mrg-half">
                    <%# FIXME: [BACKEND] hacked this together so needs to be done properly and we only show 3 tiles or less %>
                    <% 3.times do |n| %>
                      <li class="grid__item one-half non-palm-one-third">
                        <%= render partial: '/shared/tiles/deal',
                            layout: '/layouts/tile',
                            locals: {result: Hashie::Mash.new(
                              title: 'deal super #{n}',
                              retailer_logo_url: 'http://image-service.systest.dbg.westfield.com/transform?ref=fcc997784861edcc4a1bd8abd93cb5930c75dacca267636afa4a5ff47d4c3693.gif',
                              store_name: '',
                              kind: 'deal',
                              meta: Hashie::Mash.new(
                                title: '',
                                image: ''
                              )
                            )
                        } %>
                      </li>
                    <% end %>
                  </ul>
                  <%# FIXME: [BACKEND] make URL dynamic %>
                  <a href="#" class="storefront__featured__view-more">View more<span class="icon icon--arrow-right icon--lrg" aria-hidden="true"></span></a>
                </div>
              </div>
              <%# //Deal tiles %>
              <%- end %>

          </footer>
        <% end %>
        <%# Product and Deal tiles %>

      </article>

    </div>
    <%#//Store details %>

  </div>
  <%# //Contain 'back to listing link' and 'store details' %>

  <%# Map %>
  <div class="stores-maps__map map-micello js-stores-maps-toggle-map" id="stores-maps-toggle-map">
    <%= render partial: 'shared/micello_maps/map', locals: {store_id: nil, interactive: true, load_immediately: false} %>
  </div>
  <%# //Map %>

</div>

<%- content_for :javascript do -%>
  <%= javascript_include_tag 'stores_maps' %>
  <script>
    function storeMapPageReady() {

      // If the user has come from the stores index page when filtering by category
      // then set the back link to the correct category.
      if (Modernizr.localstorage) {
        if (typeof localStorage.filteredCategory != 'undefined') {
          $('.js-maintain-store-filter').attr('href', function(i, href) {
            return href + '/' + localStorage.filteredCategory;
          });
          localStorage.removeItem('filteredCategory');
        }
        if (typeof localStorage.giftCards != 'undefined' && !!localStorage.giftCards) {
          $('.js-maintain-store-filter').attr('href', function(i, href) {
            return href + '?gift_cards=true';
          });
          localStorage.removeItem('giftCards');
        }
      }

      // Target the store in the map
      storeMapPage.store(<%= @store.id %>);

      // Run 'Flexslider' plugin

      // Get the count of flexslider items
      var flexsliderItemsCount = $('.flexslider .slides li').length;

      // Only initialise flexslider if more than 1 item
      if (flexsliderItemsCount > 1) {

        $('.flexslider').flexslider({
          animationSpeed: 50,
          controlNav: true,
          directionNav: false,
          slideshow: false,
          // Do stuff when the slider loads the first slide
          start: function(slider) {
            // Add some ARIA
            slider.container.attr('role', 'listbox');
            slider.slides.attr({'role': 'option', 'aria-selected': 'false'});
            slider.slides.eq(slider.currentSlide).attr('aria-selected', 'true');
            slider.controlNav.attr({'href' : '#', 'role' : 'button'}).prepend('Show slide ');
          },
          // Do stuff after each slider animation completes
          after: function(slider) {
            slider.slides.attr('aria-selected', 'false');
            slider.slides.eq(slider.currentSlide).attr('aria-selected', 'true');
          }
        });

      }
    }
  </script>
<%- end -%>
