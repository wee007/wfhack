# config generated by ServiceHelper gem `rake service_helper:apache_config:write_all`
<VirtualHost *:80>
  ServerName beta.westfield.com.au
  ServerAlias customer-console.production.dbg.westfield.com
  ServerAlias www.uat.westfield.com.au
  ServerAlias customer-console.uat.dbg.westfield.com
  ServerAlias customer-console.systest.dbg.westfield.com
  ServerAlias customer-console.systest3.dbg.westfield.com
  ServerAlias customer-console.systest4.dbg.westfield.com
  ServerAlias customer-console.development.dbg.westfield.com
  ServerAlias customer-console.test.dbg.westfield.com

  DocumentRoot /var/www/customerconsole/current/public
  PassengerHighPerformance on

  <LocationMatch "^/assets/">
   Header unset Last-Modified
   Header unset ETag
   Header merge Cache-Control public
   FileETag None
   <IfModule !mod_expires.c>
     LoadModule expires_module modules/mod_expires.so
   </IfModule>
   ExpiresActive On
   ExpiresDefault "access plus 1 year"
  </LocationMatch>

  RewriteEngine On
  # /au/retailers/<retailer_code> => http://beta.westfield.com.au/products?retailer=<retailer_code>
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/au/retailers/(.*)/? http://%{HTTP:X-Forwarded-Host}/products?retailer=$1 [R,L]

  # /m/au/centres/bondijunction/shopping-hours => /bondijunction/hours
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/m/au/centres/(.*)/shopping-hours/? http://%{HTTP:X-Forwarded-Host}/$1/hours [R,L]

  # /m/au/centres/bondijunction => /bondijunction
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/m/au/centres/(.*)/?$ http://%{HTTP:X-Forwarded-Host}/$1 [R,L]

  # /m/au => http://westfield.com.au; /au/ => http://westfield.com.au
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/(m/)?au/?$ http://%{HTTP:X-Forwarded-Host}/ [R,L]

  # /m/au/products => http://westfield.com.au/products; /au/products => http://westfield.com.au/products
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/(m/)?au/products/?$ http://%{HTTP:X-Forwarded-Host}/products [R,L]

  # /au/centres => http://westfield.com.au/
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/au/westfield-centres/?$ http://%{HTTP:X-Forwarded-Host}/ [R,L]

  # NEED ON-SALE bug fixed for this one to work
  #RewriteCond %{HTTP:X-Forwarded-Host} .
  # RewriteRule ^/au/on-sale/?$ http://%{HTTP:X-Forwarded-Host}/ [R,L]

  # FIND OUT REDIRECT URL FOR THIS
  #RewriteCond %{HTTP:X-Forwarded-Host} .
  # RewriteRule ^/au/help/contact-us/?$ http://%{HTTP:X-Forwarded-Host}/ [R,L]
  
  # /au/brands/<brand_name> => http://westfield.com.au/products?brands=<brand_name>
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/au/brands/(.*)/?$ http://%{HTTP:X-Forwarded-Host}/products?brand=$1 [R,L]

  # /<centre_name>/centre-information/shopping-hours => http://westfield.com.au/<centre_name>/hours
  RewriteCond %{HTTP:X-Forwarded-Host} .
  RewriteRule ^/(.*)/centre-information/shopping-hours/?$ http://%{HTTP:X-Forwarded-Host}/$1/hours [R,L]

  # ================================================================
  # If you wish to use date expiries on redirects (ie; for vanity domains, use the following Conditional)
  # RewriteCond %{TIME_YEAR}%{TIME_MON}%{TIME_DAY} <20130122
 
  # [2013-10-21 mcinerney] Looks to still be needed as page renders in customerconsole.
  RewriteRule ^/sydneycentralplaza/?$ http://%{HTTP:X-Forwarded-Host}/sydney/ [R=301,L]
  RewriteRule ^/sydneycentralplaza/(.*) http://%{HTTP:X-Forwarded-Host}/sydney/$1 [R=301,L]

  # [2013-10-21 mcinerney] Until such time as we can stop advertising this, it looks like we still need it.
  RewriteCond %{HTTP:X-Forwarded-Host} ^(www\.)westfield\.com\.au$
  RewriteRule ^/retailservices/?$ https://secure.retailedge.com.au/accounts-payable/login.html [R=301,L]
   
  # FB 20299 - [2013-10-21 mcinerney] Do you have a new home for National Centres? If not either
  # drop the redirect or send it to /
  RewriteCond %{HTTP:X-Forwarded-Host} ^(www\.)westfield\.com\.au$
  RewriteRule ^/centres/?$ http://www.westfield.com.au/ [R=301,L]

  #FB 21192 - US newsletter unsubscribe
  RewriteCond %{HTTP:X-Forwarded-Host} ^(www\.)westfield\.com$
  RewriteRule ^/unsubscribe/?$ https://secure.westfield.com/unsubscribe/ [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName beta.westfield.com.au
  ServerAlias customer-console.production.dbg.westfield.com
  ServerAlias www.uat.westfield.com.au
  ServerAlias customer-console.uat.dbg.westfield.com
  ServerAlias customer-console.systest.dbg.westfield.com
  ServerAlias customer-console.systest3.dbg.westfield.com
  ServerAlias customer-console.systest4.dbg.westfield.com
  ServerAlias customer-console.development.dbg.westfield.com
  ServerAlias customer-console.test.dbg.westfield.com

  DocumentRoot /var/www/customerconsole/current/public
  PassengerHighPerformance on

  SSLEngine On
  SSLCertificateFile /etc/pki/tls/certs/localhost.crt
  SSLCertificateKeyFile /etc/pki/tls/private/localhost.key

  <LocationMatch "^/assets/">
   Header unset Last-Modified
   Header unset ETag
   Header merge Cache-Control public
   FileETag None
   ExpiresActive On
   ExpiresDefault "access plus 1 year"
  </LocationMatch>
</VirtualHost>


# ------------------------------------------------------------------------------
# | Proper MIME types for all files                                            |
# ------------------------------------------------------------------------------

<IfModule mime_module>

  # Audio
    AddType audio/mp4                                   m4a f4a f4b
    AddType audio/ogg                                   oga ogg

  # JavaScript
    # Normalize to standard type (it's sniffed in IE anyways):
    # http://tools.ietf.org/html/rfc4329#section-7.2
    AddType application/javascript                      js jsonp
    AddType application/json                            json

  # Video
    AddType video/mp4                                   mp4 m4v f4v f4p
    AddType video/ogg                                   ogv
    AddType video/webm                                  webm
    AddType video/x-flv                                 flv

  # Web fonts
    AddType application/font-woff                       woff
    AddType application/vnd.ms-fontobject               eot

    # Browsers usually ignore the font MIME types and sniff the content,
    # however, Chrome shows a warning if other MIME types are used for the
    # following fonts.
    AddType application/x-font-ttf                      ttc ttf
    AddType font/opentype                               otf

    # Make SVGZ fonts work on iPad:
    # https://twitter.com/FontSquirrel/status/14855840545
    AddType     image/svg+xml                           svg svgz
    AddEncoding gzip                                    svgz

  # Other
    AddType application/octet-stream                    safariextz
    AddType application/x-chrome-extension              crx
    AddType application/x-opera-extension               oex
    AddType application/x-shockwave-flash               swf
    AddType application/x-web-app-manifest+json         webapp
    AddType application/x-xpinstall                     xpi
    AddType application/xml                             atom rdf rss xml
    AddType image/webp                                  webp
    AddType image/x-icon                                ico
    AddType text/cache-manifest                         appcache manifest
    AddType text/vtt                                    vtt
    AddType text/x-component                            htc
    AddType text/x-vcard                                vcf

</IfModule>


# ------------------------------------------------------------------------------
# | CORS-enabled images                                                        |
# ------------------------------------------------------------------------------

# Send the CORS header for images when browsers request it.
# https://developer.mozilla.org/en/CORS_Enabled_Image
# http://blog.chromium.org/2011/07/using-cross-domain-images-in-webgl-and.html
# http://hacks.mozilla.org/2011/11/using-cors-to-load-webgl-textures-from-cross-domain-images/

<IfModule setenvif_module>
    <IfModule headers_module>
        <FilesMatch "\.(gif|ico|jpe?g|png|svg|svgz|webp)$">
            SetEnvIf Origin ":" IS_CORS
            Header set Access-Control-Allow-Origin "*" env=IS_CORS
        </FilesMatch>
    </IfModule>
</IfModule>


# ------------------------------------------------------------------------------
# | Web fonts access                                                           |
# ------------------------------------------------------------------------------

# Allow access from all domains for web fonts

<IfModule headers_module>
    <FilesMatch "\.(eot|font.css|otf|ttc|ttf|woff)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>


# ------------------------------------------------------------------------------
# | Better website experience                                                  |
# ------------------------------------------------------------------------------

# Force IE to render pages in the highest available mode in the various
# cases when it may not: http://hsivonen.iki.fi/doctype/ie-mode.pdf.

<IfModule headers_module>
    Header set X-UA-Compatible "IE=edge"
    # `mod_headers` can't match based on the content-type, however, we only
    # want to send this header for HTML pages and not for the other resources
    <FilesMatch "\.(appcache|crx|css|eot|gif|htc|ico|jpe?g|js|m4a|m4v|manifest|mp4|oex|oga|ogg|ogv|otf|pdf|png|safariextz|svg|svgz|ttf|vcf|webapp|webm|webp|woff|xml|xpi)$">
        Header unset X-UA-Compatible
    </FilesMatch>
</IfModule>
